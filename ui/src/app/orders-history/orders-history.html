<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Encomendas</title>
    <!-- Link para o CSS -->
    <link rel="stylesheet" href="orders-history.css">
    <!-- Fonte Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    
    <!-- Fundo -->
    <div class="background-decor"></div>

    <div class="container">
        <!-- Cabeçalho -->
        <header class="page-header">
            <div class="header-text">
                <h1>Histórico <span>de Encomendas</span></h1>
                <p>Acompanhe o status de produção e entrega dos seus pedidos.</p>
            </div>
            
            <div class="header-buttons">
                <button class="btn-sair" onclick="fazerLogout()">Sair</button>
                <button class="btn-voltar" onclick="window.location.href='../order/order.html'">Voltar para Loja</button>
            </div>
        </header>

        <!-- NOVO: Controles Simplificados -->
        <div class="filter-controls">
            <div class="filter-group">
                <label for="filter-status">Filtrar por Status:</label>
                <select id="filter-status" class="filter-select" onchange="aplicarFiltros()">
                    <option value="todos">Todos os Status</option>
                    <option value="1">Aguardando</option>
                    <option value="2">Em Produção</option>
                    <option value="3">Entregue</option>
                    <option value="4">Cancelado</option>
                </select>
            </div>

            <button class="btn-sort-toggle" onclick="toggleOrdenacao()" id="btn-sort" title="Ordenar por data">
                <span class="sort-label">Data</span>
                <svg class="sort-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M19 12l-7 7-7-7"/>
                </svg>
            </button>
        </div>

        <!-- Lista -->
        <main id="lista-pedidos" class="orders-grid">
            <div class="loading">Carregando seus pedidos...</div>
        </main>
    </div>

    <!-- MODAL DARK -->
    <div id="modal-container-dark" class="modal-container-dark fechado"></div>

    <!-- Script -->
    <script type="module" src="orders-history.js"></script>
</body>
</html>

<script>
function criarCardHTML(pedido) {
    let statusLabel, statusClass;

    // 1. Mapear Status
    const status = pedido.status;
    
    // Suporte para resposta string ou int da API
    if (status === 1 || status === "Waiting" || status === "waiting") {
        statusLabel = "Aguardando"; statusClass = "produzindo";
    } else if (status === 2 || status === "InProgress" || status === "inprogress") {
        statusLabel = "Em Produção"; statusClass = "produzindo";
    } else if (status === 3 || status === "Finished" || status === "finished") {
        statusLabel = "Entregue"; statusClass = "entregue";
    } else if (status === 4 || status === "Canceled" || status === "canceled") {
        statusLabel = "Cancelado"; statusClass = "cancelado";
    } else {
        // Fallback visual
        statusLabel = "Em Trânsito"; statusClass = "entregando";
    }

    // 2. Mapear Formas
    const mapearShape = (shape) => {
        if (typeof shape === 'number') return shape;
        const s = String(shape).toLowerCase();
        if (s === "hexagon") return 3;
        if (s === "square") return 2;
        if (s === "circle") return 1;
        return 0; // None/Vazio
    };

    const config = [
        mapearShape(pedido.pin1Pos1), mapearShape(pedido.pin1Pos2), mapearShape(pedido.pin1Pos3),
        mapearShape(pedido.pin2Pos1), mapearShape(pedido.pin2Pos2), mapearShape(pedido.pin2Pos3)
    ];

    // Pino 1 (Indices 0, 1, 2)
    const htmlPino1 = config.slice(0, 3).map(tipo => 
        tipo === 0 ? `<div class="mini-peca vazio"></div>` : `<div class="mini-peca tipo-${tipo}"></div>`
    ).join('');

    // Pino 2 (Indices 3, 4, 5)
    const htmlPino2 = config.slice(3, 6).map(tipo => 
        tipo === 0 ? `<div class="mini-peca vazio"></div>` : `<div class="mini-peca tipo-${tipo}"></div>`
    ).join('');

    // 3. Formatar Data
    const dataObj = new Date(pedido.created);
    const dataFormatada = dataObj.toLocaleDateString('pt-BR');

    // 4. Verificar se pode cancelar (apenas status Waiting)
    const podeCancel = (status === 1 || status === "Waiting" || status === "waiting");

    // 5. Mostrar posição na fila (minimalista)
    const infoFila = pedido.posicaoFila !== null && pedido.posicaoFila > 0
        ? `<span class="queue-position">${pedido.posicaoFila} na fila</span>`
        : '';

    // 6. Botão de cancelar (apenas se pode cancelar)
    const btnCancelar = podeCancel 
        ? `
        <div class="cancel-zone">
            <button class="btn-cancel-slide" onclick="mostrarConfirmacaoCancelamento(${pedido.id})" title="Cancelar Pedido">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </button>
        </div>
        ` 
        : '';

    // 7. Retornar HTML Estruturado
    return `
        <div class="order-card-wrapper">
            <div class="order-card ${podeCancel ? 'cancelavel' : ''}">
                <div class="order-left">
                    <div class="order-header-line">
                        <h3>Pedido #${pedido.id}</h3>
                        <span class="date-badge">${dataFormatada}</span>
                        ${infoFila}
                    </div>

                    <div class="visual-config">
                        ${htmlPino1}
                        <div class="pino-divisor"></div>
                        ${htmlPino2}
                    </div>
                </div>

                <div class="status-badge ${statusClass}">
                    ${statusLabel}
                </div>
            </div>
            ${btnCancelar}
        </div>
    `;
}

// ============================================================================
// MODAL DE CONFIRMAÇÃO DE CANCELAMENTO
// ============================================================================
window.mostrarConfirmacaoCancelamento = function(orderId) {
    const modal = document.getElementById("modal-container-dark");
    
    if (!modal) {
        console.error("Modal não encontrado!");
        return;
    }

    modal.innerHTML = '';

    const modalBox = document.createElement('div');
    modalBox.className = 'modal-box-dark';

    const modalHeader = document.createElement('div');
    modalHeader.className = 'modal-header-dark';

    const iconWrapper = document.createElement('div');
    iconWrapper.className = 'modal-icon-wrapper-dark';

    const iconBg = document.createElement('div');
    iconBg.className = 'modal-icon-bg-dark warning';
    
    iconBg.innerHTML = `
        <svg viewBox="0 0 52 52">
            <circle cx="26" cy="26" r="25"/>
            <path d="M26 14 L26 28 M26 34 L26 35"/>
        </svg>
    `;

    iconWrapper.appendChild(iconBg);
    modalHeader.appendChild(iconWrapper);

    const modalBody = document.createElement('div');
    modalBody.className = 'modal-body-dark';

    const h2 = document.createElement('h2');
    h2.textContent = 'Confirmar Cancelamento';
    h2.classList.add('warning-title');

    const p = document.createElement('p');
    p.innerHTML = `Tem certeza que deseja cancelar o <strong>Pedido #${orderId}</strong>?<br><br>Esta ação não poderá ser desfeita.`;

    const btnContainer = document.createElement('div');
    btnContainer.className = 'modal-buttons-row';
    
    const btnSim = document.createElement('button');
    btnSim.textContent = 'Cancelar';
    btnSim.className = 'btn-danger-modal';
    btnSim.onclick = () => confirmarCancelamentoPedido(orderId);
    
    const btnNao = document.createElement('button');
    btnNao.textContent = 'Manter';
    btnNao.className = 'btn-secondary-modal';
    btnNao.onclick = fecharModalDark;

    btnContainer.appendChild(btnNao);
    btnContainer.appendChild(btnSim);

    modalBody.appendChild(h2);
    modalBody.appendChild(p);
    modalBody.appendChild(btnContainer);

    modalBox.appendChild(modalHeader);
    modalBox.appendChild(modalBody);
    modal.appendChild(modalBox);

    modal.classList.remove("fechado");
};

async function confirmarCancelamentoPedido(orderId) {
    try {
        // Mostrar loading
        mostrarModalDark('Cancelando pedido...', 'loading');

        // Buscar o pedido atualizado
        const response = await fetch(`http://localhost:5150/api/Order/${orderId}`);
        
        if (!response.ok) {
            throw new Error('Não foi possível verificar o status do pedido.');
        }

        const pedidoAtual = await response.json();

        // Verificar se ainda está em "Waiting"
        if (pedidoAtual.status !== 1 && pedidoAtual.status !== "Waiting") {
            mostrarModalDark(
                'Este pedido não pode mais ser cancelado.<br>O status foi alterado para: <strong>' + 
                mapearStatusParaTexto(pedidoAtual.status) + '</strong>',
                'warning'
            );
            return;
        }

        // Cancelar
        const cancelResponse = await fetch(`http://localhost:5150/api/Order/${orderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(4) // 4 = Canceled
        });

        if (!cancelResponse.ok) {
            const errorData = await cancelResponse.json();
            throw new Error(errorData.Message || errorData.message || 'Falha ao cancelar o pedido.');
        }

        // Sucesso
        mostrarModalDark(`Pedido #${orderId} cancelado com sucesso!`, 'sucesso');
        
        // Recarregar após 2 segundos
        setTimeout(() => {
            fecharModalDark();
            carregarPedidos();
        }, 2000);

    } catch (error) {
        console.error('Erro ao cancelar pedido:', error);
        mostrarModalDark(
            `Erro ao cancelar pedido:<br>${error.message}`,
            'erro'
        );
    }
}
</script>